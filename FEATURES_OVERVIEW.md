# 🎵 音乐库智能分析工具 - 功能总览

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│          🎵 音乐库智能分析工具 - 功能框架                    │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│   📱 Web 界面        │
│    (Streamlit)       │
│                      │
│  • 路径导航          │
│  • 扫描控制          │
│  • 结果展示          │
│  • 删除操作          │
│  • 清单导出          │
└──────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│              🔧 核心分析引擎 (Analyzer)                      │
│                                                              │
│  ┌──────────────────┐    ┌──────────────────┐               │
│  │ 重复歌曲检测     │    │ 多版本分析       │               │
│  │ ┌──────────────┐ │    │ ┌──────────────┐ │               │
│  │ │ 基于 song_key│ │    │ │ 格式分类     │ │               │
│  │ │ 识别完全重复 │ │    │ │ 版本统计     │ │               │
│  │ └──────────────┘ │    │ └──────────────┘ │               │
│  └──────────────────┘    └──────────────────┘               │
│           ↓                        ↓                        │
│  ┌──────────────────┐    ┌──────────────────┐               │
│  │ 标记删除        │    │ MP3 检测         │               │
│  │ ┌──────────────┐ │    │ ┌──────────────┐ │               │
│  │ │ 保留高优先级 │ │    │ │ 仅 MP3 格式  │ │               │
│  │ │ 删除低优先级 │ │    │ │ 质量评级     │ │               │
│  │ └──────────────┘ │    │ └──────────────┘ │               │
│  └──────────────────┘    └──────────────────┘               │
└──────────────────────────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────────────────────────┐
│           📂 数据源 - 音乐库扫描 (Scanner)                   │
│                                                              │
│  递归扫描 → 提取元数据 → 过滤音频文件 → 返回列表             │
│                                                              │
│  支持格式：MP3, FLAC, WAV, M4A, ALAC, OGG 等                │
└──────────────────────────────────────────────────────────────┘
```

---

## 📊 三大核心功能

### 🔁 功能1：重复歌曲识别与清理

**工作原理：**
```
扫描结果
    ↓
按 song_key 分组
    ↓
检测同 key 多文件
    ↓
按格式优先级排序
    ↓
标记低优先级删除
    ↓
生成删除清单
```

**用户操作：**
```
1. 扫描音乐库
2. 查看 "🔁 重复歌曲" 
3. 分页浏览重复文件
4. 点击 "🗑️ 删除"
5. 确认删除低优先级版本
```

**示例：**
```
🎵 song|artist|200
  ├─ song.mp3 (320kbps) ✗ 删除
  ├─ song.flac (无损) ✓ 保留
  └─ song.wav (无损) ✗ 删除
```

---

### 🎚️ 功能2：多版本歌曲优化

**工作原理：**
```
扫描结果
    ↓
按 song_key 分组
    ↓
统计每首歌的格式
    ↓
识别多版本歌曲
    ↓
标记最优版本
    ↓
显示版本详情
```

**用户操作：**
```
1. 扫描音乐库
2. 查看 "🎚️ 多版本歌曲"
3. 了解每首歌的版本情况
4. 决定是否清理非最优版本
5. （可选）在酷我音乐补全缺失版本
```

**示例：**
```
🎵 song|artist|200
  ├─ MP3 (320kbps)
  ├─ FLAC (无损) ← 最优版本
  └─ AAC (256kbps)
```

---

### 🎧 功能3：低质量MP3检测与升级

**工作原理：**
```
扫描结果
    ↓
按 song_key 分组
    ↓
检测仅含 MP3 的歌曲
    ↓
提取元数据（艺术家、比特率）
    ↓
生成升级清单
    ↓
导出多种格式
```

**升级工作流：**
```
音乐分析工具
    ↓
导出清单
    ↓
在酷我音乐搜索
    ↓
下载 FLAC 版本
    ↓
放回音乐目录
    ↓
重新扫描验证
    ↓
✅ 升级完成
```

**示例：**
```
仅MP3歌曲 (66首)

【1】 Song A | Artist A
  原格式: MP3 (320kbps)
  建议: FLAC (无损)
  
【2】 Song B | Artist B
  原格式: MP3 (128kbps)
  建议: WAV 或 FLAC
```

---

## 🚀 新增功能：下载清单生成

### export_download_list.py

**作用：**
- 自动生成需要升级的歌曲清单
- 支持 CSV、TXT、JSON 三种格式
- 便于在酷我音乐中批量搜索

**集成方式：**

**方式1：Web 应用内导出**
```
Streamlit 应用
  ↓
侧栏 "📝 导出清单" 按钮
  ↓
自动生成和下载清单
  ↓
exports/ 目录
```

**方式2：独立运行**
```bash
python export_download_list.py
```

### 导出格式对比

| 格式 | 用途 | 优点 | 缺点 |
|-----|------|------|------|
| CSV | 数据分析 | 可在 Excel 打开 | 格式不够易读 |
| TXT | 手动操作 | 易读、便于复制 | 不能导入Excel |
| JSON | 程序处理 | 结构化数据 | 需要编程知识 |

### 导出内容

**仅MP3歌曲清单** 🔴 高优先级
- 歌曲标题
- 艺术家
- 当前比特率
- 原始文件名
- 优先级标记

**多版本歌曲清单** 🟡 中优先级
- 歌曲标题
- 艺术家
- 所有版本格式
- 最优格式标记
- 版本数量统计

---

## 📈 流程完整示例

### 用户场景：整理音乐库

**初始状态：**
```
G:\music
├─ Artist1
│  ├─ song1.mp3 (128kbps) ❌ 低质量
│  ├─ song1.flac
│  ├─ song2.mp3 (320kbps)
│  └─ song2.mp3 (另一个) ❌ 重复
└─ Artist2
   ├─ song3.mp3 (128kbps) ❌ 低质量
   └─ song3.aac (192kbps)
```

**第1步：启动应用**
```bash
streamlit run app.py
```

**第2步：扫描库**
```
输入路径: G:\music
点击: 🔍 开始扫描
等待: 扫描完成 (714 个文件)
```

**第3步：查看统计**
```
📦 文件总数: 714
🎵 唯一歌曲: 637
🎚️ 多版本歌曲: 12
🎧 仅 MP3 歌曲: 66
```

**第4步A：快速清理（仅删除重复）**
```
1. 点击: 🔁 重复歌曲 (5)
2. 查看: 5 个重复文件
3. 点击: 🗑️ 删除
4. 确认: ✅ 已删除 3 个文件
```

**第4步B：升级方案（推荐）**
```
1. 点击: 📝 导出清单
2. 生成: CSV、TXT、JSON 文件
3. 打开: exports/download_list_*.txt
4. 复制: 歌曲名到酷我音乐
5. 下载: FLAC 版本
6. 保存: 到原目录
```

**第5步：验证**
```
再次扫描库
查看新的统计
确认: 仅 MP3 歌曲 从 66 → 0
```

**最终状态：**
```
G:\music
├─ Artist1
│  ├─ song1.flac ✓ 最优
│  └─ song2.flac ✓ 已升级
└─ Artist2
   └─ song3.flac ✓ 已升级
```

---

## 🔄 数据流转图

```
┌────────────────────────────────────────────────────────────┐
│                  用户输入                                   │
│            (路径、功能选择、删除确认)                       │
└────────────┬───────────────────────────────────────────────┘
             ↓
┌────────────────────────────────────────────────────────────┐
│               Streamlit 前端 (app.py)                      │
│                                                            │
│  侧栏：路径导航、功能选择、导出工具                        │
│  主区：结果展示、分页导航、删除表单                        │
└────────────┬───────────────────────────────────────────────┘
             ↓
┌────────────────────────────────────────────────────────────┐
│           数据处理后端 (analyzer.py)                       │
│                                                            │
│  • 去重分组 (find_duplicates)                             │
│  • 版本统计 (find_multi_version)                          │
│  • MP3检测 (find_mp3_only)                                │
│  • 删除标记 (get_duplicates_to_delete)                    │
└────────────┬───────────────────────────────────────────────┘
             ↓
┌────────────────────────────────────────────────────────────┐
│            文件系统扫描 (scanner.py)                       │
│                                                            │
│  递归遍历 → Mutagen 提取 → 返回 DataFrame                 │
└────────────┬───────────────────────────────────────────────┘
             ↓
┌────────────────────────────────────────────────────────────┐
│             音乐库数据 (G:\music)                          │
│                                                            │
│  MP3、FLAC、WAV、AAC、ALAC 等多种格式                    │
└────────────────────────────────────────────────────────────┘
```

---

## 💾 导出工作流

```
当前扫描结果 (DataFrame)
    ↓
分类处理
├─ 仅MP3歌曲列表
└─ 多版本歌曲列表
    ↓
多格式导出
├─ CSV → Excel 分析
├─ TXT → 手动操作
└─ JSON → 程序处理
    ↓
保存到 exports/ 目录
    ↓
用户查看和使用
```

---

## 🎯 质量改进路线图

### 第一阶段：清理 ✅（完成）
- [x] 识别重复文件
- [x] 智能删除低优先级版本
- [x] 支持多版本分析

### 第二阶段：升级 ✅（现在进行）
- [x] 生成升级清单
- [x] 多格式导出
- [x] 便于手动下载

### 第三阶段：自动化（未来）
- [ ] 直接与酷我音乐 API 集成
- [ ] 自动下载功能
- [ ] 后台守护进程

---

## 📋 快速参考

### 快捷启动
```bash
# 启动应用
run.bat

# 或直接
streamlit run app.py

# 或生成清单
python export_download_list.py
```

### 快速操作

| 目标 | 操作 |
|-----|------|
| 查看重复 | 扫描 → 点击 🔁 |
| 查看多版本 | 扫描 → 点击 🎚️ |
| 查看低质MP3 | 扫描 → 点击 🎧 |
| 导出清单 | 扫描 → 点击 📝 |
| 删除文件 | 查看 → 点击 🗑️ |

### 格式优先级速查

```
FLAC/WAV/ALAC (无损) 优先
    ↓
AAC (有损中等质量)
    ↓
MP3 (有损最低质量)
```

---

**文档更新**：2026-01-17  
**工具版本**：2.0
